#!/usr/bin/env python

"""autocut_vod.py

This file provides a CLI for automatically recutting a downloaded
Critical Role VOD in mp4 form.

"""

import sys
from argparse import ArgumentParser
import tempfile
import shutil

from cr_download import cli_utils
from cr_download import cr_convert

def _init_args():
    parser = ArgumentParser(
        description="""Automatically recut the .mp4 video file for a
        Critical Role episode"""
    )

    parser.add_argument("filenames", nargs="+",
                        help="""filename(s) of .mp4 files to autocut""")

    parser.add_argument("--autocut-ignore-errors", action="store_true",
                        help="""On autocut errors, just merge output into a
                        single audio file""")

    parser.add_argument("-d", "--debug", dest="debug", action="store_true",
                        help="debug mode (keep temporary files)")

    parser.add_argument("-m", "--merge", action="store_true",
                        help="merge all VODs into a single episode")

    parser.add_argument("-M", "--autocut-merge", action="store_true",
                        help="""merge autocut audio into a single
                        file""")

    parser.add_argument("-n", "--no-autocut", action="store_false",
                        dest="autocut", help="""Don't autocut, just
                        convert to a single unedited audio file""")

    parser.add_argument("--cutting-sequence", default="default",
                        help="""which cutting sequence to use when autocutting
                        files (default behavior specified in config file)""")

    parser.add_argument("-k", "--keep-intro", action="store_const",
                        dest="cutting_sequence", const="keep",
                        help="""when autocutting, keep the pre-show
                        announcements/intro section""")

    parser.add_argument("--cut-intro", action="store_const",
                        dest="cutting_sequence", const="cut",
                        help="""when autocutting, cut the pre-show
                        announcements/intro section""")

    return parser.parse_args(sys.argv[1:])


def _main(arguments):
    split_episodes = (arguments.autocut and not arguments.autocut_merge)
    vods = {}

    if arguments.merge:
        title = cli_utils.prompt_title(multiple_parts=split_episodes)
        vods[title] = arguments.filenames
    else:
        for filename in arguments.filenames:
            title = cli_utils.prompt_title(multiple_parts=split_episodes)
            vods[title] = [filename]

    tmpdir = tempfile.mkdtemp()
    try:
        audio_files = {
            title: cr_convert.videos_to_episode_audio(
                video_files, title, arguments, tmpdir)
            for title, video_files in vods.items()
        }
        print("Output audio files to:\n" + "\n".join(sorted(list(audio_files))))
    finally:
        if not arguments.debug:
            shutil.rmtree(tmpdir)


if __name__ == "__main__":
    _main(_init_args())
