#!/usr/bin/env python

"""autocut_vod.py

This file provides a CLI for automatically recutting a downloaded
Critical Role VOD in mp4 form.

"""

import sys
from argparse import ArgumentParser
import tempfile
import shutil

from cr_download import autocutter
from cr_download import media_utils
from cr_download import cli_utils

def _init_args():
    parser = ArgumentParser(
        description="""Automatically recut the .mp4 video file for a
        Critical Role episode"""
    )

    parser.add_argument("filenames", nargs="+",
                        help="""filename(s) of .mp4 files to autocut""")

    parser.add_argument("-d", "--debug", dest="debug", action="store_true",
                        help="debug mode (keep temporary files)")

    parser.add_argument("-m", "--merge", action="store_true",
                        dest="autocut_merge", help="""merge autocut
                        audio into a single file""")

    parser.add_argument("-n", "--no-autocut", action="store_false",
                        dest="autocut", help="""Don't autocut, just
                        convert to a single unedited audio file""")

    parser.add_argument("--cutting-sequence", default="default",
                        help="""which cutting sequence to use when autocutting
                        files (default behavior specified in config file)""")

    parser.add_argument("-k", "--keep-intro", action="store_const",
                        dest="cutting_sequence", const="keep",
                        help="""when autocutting, keep the pre-show
                        announcements/intro section""")

    parser.add_argument("--cut-intro", action="store_const",
                        dest="cutting_sequence", const="cut",
                        help="""when autocutting, cut the pre-show
                        announcements/intro section""")

    return parser.parse_args(sys.argv[1:])


def _main(arguments):
    vod = {"title":""}
    title = cli_utils.prompt_title(vod, arguments.autocut)
    tmpdir = tempfile.mkdtemp()
    try:
        episodes = []
        for filename in arguments.filenames:
            episodes.append(
                media_utils.mp4_to_audio_segments(
                    filename, tmpdir,
                    segment_fmt=".wav"))

        audio_files = []
        for episode_segments in episodes:
            audio_files += autocutter.autocut(
                episode_segments, title,
                arguments.cutting_sequence,
                merge_segments=arguments.autocut_merge,
                debug=arguments.debug)

            audio_files.append(media_utils.merge_audio_files(episode_segments, title))

        print("Output audio files to:\n" + "\n".join(sorted(list(audio_files))))
    finally:
        if not arguments.debug:
            shutil.rmtree(tmpdir)


if __name__ == "__main__":
    _main(_init_args())
